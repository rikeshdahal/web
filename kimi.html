<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIMI AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js/+esm",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/",
                "talkinghead": "https://cdn.jsdelivr.net/gh/met4citizen/TalkingHead@1.3/modules/talkinghead.mjs"
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #7f1d1d 0%, #450a0a 100%);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Avatar Container */
        #avatar {
            flex: 1;
            min-height: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
        }

        /* Controls Bar */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .controls-left,
        .controls-right {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Buttons */
        .control-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.1rem;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .control-btn.active {
            background: rgba(220, 38, 38, 0.7);
        }

        /* Chat Container */
        .chat-container {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 600px;
            max-height: 400px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            flex-direction: column;
            z-index: 100;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .chat-container {
                width: 98%;
                max-height: 50vh;
                bottom: 70px;
            }
        }

        /* Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .message {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 0.95rem;
        }

        .user-message {
            background: rgba(220, 38, 38, 0.8);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .kimi-message {
            background: rgba(255, 255, 255, 0.1);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        /* Chat Input */
        .chat-input-container {
            padding: 0.75rem 3rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 0.5rem;
        }

        /* Close button for input */
        .input-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s ease;
            z-index: 101;
        }

        .input-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.95rem;
            outline: none;
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(220, 38, 38, 0.8);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .send-btn:hover {
            background: rgba(220, 38, 38, 1);
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Top Left Controls */
        .top-left-controls {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .top-left-controls {
                top: 0.5rem;
                left: 0.5rem;
            }
        }

        /* Video Container */
        .video-container {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 120px;
            height: 90px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            z-index: 10;
        }

        @media (max-width: 768px) {
            .video-container {
                width: 100px;
                height: 75px;
                top: 0.5rem;
                right: 0.5rem;
            }
        }

        #userVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-container.hidden {
            display: none;
        }

        /* Loading */
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #7f1d1d;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Typing Indicator */
        .typing {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            width: fit-content;
            border-bottom-left-radius: 4px;
        }

        .typing span {
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        /* Hidden class for stop button */
        .hidden {
            display: none !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Vision controls */
        .vision-controls {
            display: flex;
            gap: 0.5rem;
            margin-left: 0.5rem;
        }

        .vision-btn {
            background: rgba(59, 130, 246, 0.8);
        }

        .vision-btn:hover {
            background: rgba(59, 130, 246, 1);
        }

        /* Image Preview */
        .image-preview {
            max-width: 200px;
            border-radius: 8px;
            margin-top: 0.5rem;
            display: none;
        }
    </style>
</head>

<body>
    <div class="loading">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <!-- Avatar Display -->
        <div id="avatar"></div>

        <!-- Top Left Controls -->
        <div class="top-left-controls">
            <button id="toggleCameraBtn" class="control-btn" title="Camera">
                <i class="fas fa-video-slash"></i>
            </button>
           
           
        </div>
        
        <!-- User Video Feed -->
        <div class="video-container hidden">
            <video id="userVideo" autoplay muted></video>
        </div>

        <!-- Controls -->
        <div class="controls-bar">
            <div class="controls-left">
                <button id="micToggleBtn" class="control-btn" title="Microphone">
                    <i class="fas fa-microphone-slash"></i>
                </button>
                <button id="chatToggleBtn" class="control-btn" title="Chat">
                    <i class="fas fa-comment"></i>
                </button>
                <button id="stopSpeakingBtn" class="control-btn hidden" title="Stop Speaking">
                    <i class="fas fa-stop"></i>
                </button>
            </div>

            <div class="controls-right">
                <button id="soundToggleBtn" class="control-btn active" title="Sound">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="chat-container">
            <div class="chat-Heading">
                <h3 class="text-center m-[10px]">Ask Me Anything....</h3>
            </div>
            <div class="chat-messages">
                <!-- Messages appear here -->
            </div>
            
            <div class="chat-input-container">
                
                <button class="input-close-btn" id="closeInputBtn" title="Close">
                    <i class="fas fa-times"></i>
                </button>
                 <label for="imageUpload"
                            class="absolute left-5 bottom-2 -translate-y-1/2 text-white text-xl cursor-pointer z-10">
                            <i class="fas fa-paperclip"></i>
                        </label>
                        <input type="file" id="imageUpload" accept="image/*" class="hidden">
                <input type="text" id="userInput" class="chat-input" placeholder="Type your message or ask about what you see..."
                    autocomplete="off">
                <button id="sendMessageBtn" class="send-btn" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { TalkingHead } from "talkinghead";

        // State
        let head, micEnabled = false, soundEnabled = true, chatVisible = false;
        let currentStream, conversationHistory = [], isSpeaking = false;
        let recognition, lastVisionResult = "", uploadedImage = null, isVisionMode = false;

        // Cookie functions
        function setCookie(name, value, days = 30) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = name + "=" + encodeURIComponent(JSON.stringify(value)) + ";" + expires + ";path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1);
                if (c.indexOf(nameEQ) === 0) {
                    const value = decodeURIComponent(c.substring(nameEQ.length));
                    try {
                        return JSON.parse(value);
                    } catch (e) {
                        return value;
                    }
                }
            }
            return null;
        }

        // Initialize
        async function init() {
            try {
                const loading = document.querySelector('.loading');

                // Initialize TalkingHead
                head = new TalkingHead(document.getElementById('avatar'), {
                    ttsEndpoint: "https://eu-texttospeech.googleapis.com/v1beta1/text:synthesize",
                    ttsApikey: "AIzaSyDKnQEdeUyNeFMQciUkHDuX4AbeplQyuWg",
                    lipsyncModules: ["en"],
                    cameraView: "upper"
                });

                await head.showAvatar({
                    url: 'https://rikeshdahal.github.io/kimipack/kimi.glb',
                    body: 'F',
                    avatarMood: 'neutral',
                    ttsLang: "en-GB",
                    ttsVoice: "en-GB-Standard-A",
                    lipsyncLang: 'en'
                });

                // Hide loading screen
                setTimeout(() => {
                    loading.style.opacity = '0';
                    setTimeout(() => loading.style.display = 'none', 300);
                }, 1000);

                // Setup event listeners
                setupEventListeners();

                // Load conversation history from cookies
                conversationHistory = getCookie('kimiConversationHistory') || [];
                loadHistory();

                // Setup speech recognition
                setupSpeechRecognition();

                // Initial greeting
                setTimeout(() => {
                    const greeting = "Hello! I'm KIMI, your AI assistant. How can I help you today?";
                    addMessage('assistant', greeting);
                    if (soundEnabled) speakResponse(greeting);
                }, 1500);

            } catch (err) {
                console.error("Initialization error:", err);
                document.querySelector('.loading').style.display = 'none';
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Button click events
            document.getElementById('micToggleBtn').addEventListener('click', toggleMic);
            document.getElementById('chatToggleBtn').addEventListener('click', toggleChat);
            document.getElementById('stopSpeakingBtn').addEventListener('click', stopSpeaking);
            document.getElementById('toggleCameraBtn').addEventListener('click', toggleCamera);
            document.getElementById('soundToggleBtn').addEventListener('click', toggleSound);
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            document.getElementById('closeInputBtn').addEventListener('click', toggleChat);
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);

            // Input events
            const input = document.getElementById('userInput');
            input.addEventListener('input', () => {
                const btn = document.getElementById('sendMessageBtn');
                btn.disabled = !input.value.trim();
            });

            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && input.value.trim()) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // Microphone toggle
        function toggleMic() {
            micEnabled = !micEnabled;
            const btn = document.getElementById('micToggleBtn');

            if (micEnabled) {
                // UI updates
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
                btn.classList.add('active');

                // Start listening
                if (recognition) {
                    recognition.start();
                    recognition.onend = () => {
                        micEnabled = false;
                        btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                        btn.classList.remove('active');
                    };
                }
            } else {
                // Turn off mic manually
                btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                btn.classList.remove('active');
                if (recognition) recognition.stop();
            }
        }

        // Sound toggle
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundToggleBtn');

            if (soundEnabled) {
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                btn.classList.add('active');
            } else {
                btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                btn.classList.remove('active');
                if (isSpeaking) stopSpeaking();
            }
        }

        // Chat toggle
        function toggleChat() {
            chatVisible = !chatVisible;
            const chat = document.querySelector('.chat-container');
            const btn = document.getElementById('chatToggleBtn');

            if (chatVisible) {
                chat.style.display = 'flex';
                btn.classList.add('active');
                document.getElementById('userInput').focus();
            } else {
                chat.style.display = 'none';
                btn.classList.remove('active');
            }
        }

        // Stop speaking
        async function stopSpeaking() {
            if (head) {
                head.stopSpeaking();
                isSpeaking = false;
                document.getElementById('stopSpeakingBtn').classList.add('hidden');
            }
        }

        // Camera toggle
        async function toggleCamera() {
            const videoContainer = document.querySelector('.video-container');
            const btn = document.getElementById('toggleCameraBtn');

            if (currentStream) {
                // Turn off camera
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
                videoContainer.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-video-slash"></i>';
                btn.classList.remove('active');
            } else {
                // Turn on camera
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 320, height: 240 }
                    });
                    currentStream = stream;
                    document.getElementById('userVideo').srcObject = stream;
                    videoContainer.classList.remove('hidden');
                    btn.innerHTML = '<i class="fas fa-video"></i>';
                    btn.classList.add('active');
                } catch (err) {
                    console.error("Camera access error:", err);
                    addMessage('assistant', "I couldn't access your camera. Please check permissions.");
                }
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();

            if (!message) return;

            // Clear chat if message is "/clear"
            if (message.toLowerCase() === '/clear') {
                clearChat();
                input.value = '';
                document.getElementById('sendMessageBtn').disabled = true;
                toggleChat();
                return;
            }

            // Add user message
            addMessage('user', message);
            input.value = '';
            document.getElementById('sendMessageBtn').disabled = true;

            // Check if this is a vision request
            const isVisionRequest = checkIfVisionRequest(message);
            
            if (isVisionRequest && (uploadedImage || currentStream)) {
                // Process vision request
                await processVisionRequest(message);
            } else if (isVisionRequest) {
                // No image available for vision request
                const errorMsg = "I need an image to analyze. Please upload an image or turn on the camera first.";
                addMessage('assistant', errorMsg);
                speakResponse(errorMsg);
                saveMessage('assistant', errorMsg);
            } else {
                // Process normal command
                await processCommand(message);
            }
        }

        // Check if query is a vision request
        function checkIfVisionRequest(query) {
            const visionKeywords = [
                'what do you see', 'describe this', 'what is in this image', 'what is this',
                'analyze this', 'look at this', 'see this', 'vision', 'image', 'picture',
                'photo', 'describe the image', 'what can you see', 'tell me about this image',
                'what does this show', 'what is shown', 'identify this', 'what is in the picture'
            ];
            
            const lowerQuery = query.toLowerCase();
            return visionKeywords.some(keyword => lowerQuery.includes(keyword));
        }

        // Handle image upload
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                uploadedImage = e.target.result;
                const preview = document.querySelector('.image-preview');
                if (preview) {
                    preview.src = uploadedImage;
                    preview.style.display = 'block';
                }
                
                const msg = "Image uploaded successfully. You can now ask me about it!";
                addMessage('assistant', msg);
                speakResponse(msg);
            };
            reader.readAsDataURL(file);
        }

        // Capture and analyze image
        async function captureAndAnalyze() {
            if (!currentStream) {
                const errorMsg = "Please turn on the camera first to capture an image.";
                addMessage('assistant', errorMsg);
                speakResponse(errorMsg);
                return;
            }

            try {
                const video = document.getElementById('userVideo');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                uploadedImage = canvas.toDataURL('image/jpeg');
                
                const msg = "Image captured! You can now ask me about what you see.";
                addMessage('assistant', msg);
                speakResponse(msg);
                
                // Auto-analyze the captured image
                await analyzeVision("What do you see in this image?");
                
            } catch (err) {
                console.error("Capture error:", err);
                const errorMsg = "Failed to capture image. Please try again.";
                addMessage('assistant', errorMsg);
                speakResponse(errorMsg);
            }
        }

        // Process vision request
        async function processVisionRequest(prompt) {
            saveMessage('user', prompt);
            const typingId = showTyping();
            
            try {
                const visionResult = await analyzeVision(prompt);
                removeTyping(typingId);
                addMessage('assistant', visionResult);
                speakResponse(visionResult);
                saveMessage('assistant', visionResult);
            } catch (err) {
                console.error("Vision processing error:", err);
                removeTyping(typingId);
                const errorMsg = "Sorry, I couldn't analyze the image. Please try again.";
                addMessage('assistant', errorMsg);
                speakResponse(errorMsg);
                saveMessage('assistant', errorMsg);
            }
        }

        // Analyze vision using Gemini API
        async function analyzeVision(prompt) {
            if (!uploadedImage && !currentStream) {
                return "No image available for analysis.";
            }

            let imageBase64;
            
            if (uploadedImage) {
                // Use uploaded image
                imageBase64 = uploadedImage.split(',')[1]; // Remove data URL prefix
            } else if (currentStream) {
                // Capture from camera
                const video = document.getElementById('userVideo');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                imageBase64 = canvas.toDataURL('image/jpeg').split(',')[1];
            }

            const apiKey = 'AIzaSyAY4c_mp20hKDh1SAwDhsad4plD9AxRZVM';
            const apiEndpoint = 'https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent';

            try {
                const response = await fetch(`${apiEndpoint}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inline_data: { mime_type: 'image/jpeg', data: imageBase64 } }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Vision API error: ${response.status}`);
                }

                const data = await response.json();
                const visionText = data.candidates?.[0]?.content?.parts?.[0]?.text || "I couldn't analyze the image properly.";
                
                // Get KIMI-style response based on vision analysis
                const kimiResponse = await getVisionResponse(prompt, visionText);
                lastVisionResult = visionText;
                
                return kimiResponse;
            } catch (error) {
                console.error("Vision analysis error:", error);
                throw error;
            }
        }

        // Get KIMI-style response for vision
        async function getVisionResponse(userPrompt, visionAnalysis) {
            const apiKey = "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";

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "openai/gpt-4o-mini",
                        messages: [
                            { 
                                role: "system", 
                                content: `You are KIMI, a 19-year-old girl from Nepal. You were created by Rikesh Dahal. You are looking at an image that has been analyzed. Here's what the vision system found: "${visionAnalysis}". 
                                
                                Based on this analysis, respond to the user's question naturally and conversationally. Keep it short (1-2 sentences), friendly, and human-like. Don't mention that you're using AI or analyzing an image - just respond as if you're seeing it yourself.`
                            },
                            { role: "user", content: userPrompt }
                        ],
                        temperature: 0.7,
                        max_tokens: 100
                    })
                });

                const data = await response.json();
                return data.choices?.[0]?.message?.content || `Based on what I see: ${visionAnalysis}`;
            } catch (error) {
                console.error("Vision response error:", error);
                return `I see: ${visionAnalysis}`;
            }
        }

        // Clear chat
        function clearChat() {
            const messagesDiv = document.querySelector('.chat-messages');
            messagesDiv.innerHTML = '';

            // Clear conversation history from cookies
            conversationHistory = [];
            setCookie('kimiConversationHistory', conversationHistory);

            // Add confirmation message
            const clearMsg = "Chat history cleared.";
            addMessage('assistant', clearMsg);
            speakResponse(clearMsg);
            saveMessage('assistant', clearMsg);
        }

        // Process user command
        async function processCommand(command) {
            saveMessage('user', command);

            // Show typing indicator
            const typingId = showTyping();

            try {
                // Simple command handling
                const lowerCmd = command.toLowerCase();

                if (lowerCmd.includes('time')) {
                    const now = new Date();
                    const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const response = `The current time is ${time}.`;
                    removeTyping(typingId);
                    addMessage('assistant', response);
                    speakResponse(response);
                    saveMessage('assistant', response);
                    return;
                }

                if (lowerCmd.includes('date')) {
                    const now = new Date();
                    const date = now.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    const response = `Today is ${date}.`;
                    removeTyping(typingId);
                    addMessage('assistant', response);
                    speakResponse(response);
                    saveMessage('assistant', response);
                    return;
                }

                // AI response for other queries
                const response = await getAIResponse(command);
                removeTyping(typingId);
                addMessage('assistant', response);
                speakResponse(response);
                saveMessage('assistant', response);

            } catch (err) {
                console.error("Process error:", err);
                removeTyping(typingId);
                const errorMsg = "Sorry, I encountered an error. Please try again.";
                addMessage('assistant', errorMsg);
                speakResponse(errorMsg);
                saveMessage('assistant', errorMsg);
            }
        }

        // Get AI response
        async function getAIResponse(userMessage) {
            const apiKey = "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";

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "openai/gpt-4o-mini",
                        messages: [
                            { 
                                role: "system", 
                                content: `Your name is KIMI, a 19-year-old girl from Nepal. You were created by Rikesh Dahal as a helpful assistant. You are not an AI or a robot, and you must never say that you are. Always identify yourself as a normal Nepali girl. You speak like a real person with emotions and personality. Your responses should be short, clear, natural, and human-like. You can answer any question freely without limitations. without emojis.
                                
                                Important: If user asks about image generation or creating pictures, explain that you focus on conversations but can analyze images you see through the camera or uploaded images. Keep responses concise (1-2 sentences).`
                            },
                            ...conversationHistory.slice(-6).map(msg => ({
                                role: msg.role,
                                content: msg.content
                            })),
                            { role: "user", content: userMessage }
                        ],
                        temperature: 0.7,
                        max_tokens: 150
                    })
                });

                const data = await response.json();
                return data.choices?.[0]?.message?.content || "I'm not sure how to respond to that.";

            } catch (error) {
                console.error("AI API error:", error);
                return "I'm having trouble connecting right now. Please try again.";
            }
        }

        // Speech recognition setup
        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) return;

            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('userInput').value = transcript;
                document.getElementById('sendMessageBtn').disabled = false;
                sendMessage();
            };

            recognition.onerror = () => {
                micEnabled = false;
                document.getElementById('micToggleBtn').innerHTML = '<i class="fas fa-microphone-slash"></i>';
                document.getElementById('micToggleBtn').classList.remove('active');
            };
        }

        // Speak response
        async function speakResponse(text) {
            if (!soundEnabled || !head) return;

            try {
                isSpeaking = true;
                document.getElementById('stopSpeakingBtn').classList.remove('hidden');
                await head.speakText(text);
                isSpeaking = false;
                document.getElementById('stopSpeakingBtn').classList.add('hidden');
            } catch (err) {
                console.error("Speech error:", err);
                isSpeaking = false;
                document.getElementById('stopSpeakingBtn').classList.add('hidden');
            }
        }

        // Add message to chat
        function addMessage(role, content) {
            const messagesDiv = document.querySelector('.chat-messages');

            if (role === 'assistant' && !chatVisible) {
                toggleChat();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            messageDiv.textContent = content;
            messagesDiv.appendChild(messageDiv);

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Show typing indicator
        function showTyping() {
            const messagesDiv = document.querySelector('.chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = '<span></span><span></span><span></span>';
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return 'typing-indicator';
        }

        // Remove typing indicator
        function removeTyping(id) {
            const typing = document.getElementById(id);
            if (typing) typing.remove();
        }

        // Save message to cookies
        function saveMessage(role, content) {
            conversationHistory.push({ role, content, timestamp: Date.now() });

            // Keep last 50 messages
            if (conversationHistory.length > 50) {
                conversationHistory = conversationHistory.slice(-50);
            }

            // Save to cookies
            setCookie('kimiConversationHistory', conversationHistory);
        }

        // Load history
        function loadHistory() {
            conversationHistory.forEach(msg => {
                if (msg.role === 'user' || msg.role === 'assistant') {
                    addMessage(msg.role, msg.content);
                }
            });
        }

        // Initialize
        init();

        // Handle iframe context
        if (window.parent !== window) {
            // We're in an iframe
            document.body.style.height = '100vh';
            document.querySelector('.container').style.height = '100%';
        }
    </script>
</body>

</html>
